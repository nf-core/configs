/*
 * =========================
 *  GLOBAL DEFAULT SETTINGS
 * =========================
 */

params {

  /*
   * Execution behaviour
   */
  fail_fast            = false        // true = stop on first error
  skip_samples_on_fail = true
  exclude_samples      = []

  /*
   * Resource caps (global maximums)
   */
  max_cpus   = 64
  max_memory = 250.GB
  max_time   = 24.h

  /*
   * Logging
   */
  log_dir = 'logs'
}


/*
 * =========================
 *  PROCESS DEFAULTS
 * =========================
 */

process {

  errorStrategy = params.fail_fast ? 'terminate' : 'ignore'
  maxRetries    = 0
  maxErrors     = -1

  /*
   * Resource requests
   * Individual processes can still override these
   */
  cpus   { Math.min(64, params.max_cpus) }
  memory { params.max_memory }
  time   { params.max_time }

  scratch        = true
  publishDirMode = 'copy'
}


/*
 * =========================
 *  CONTAINER SUPPORT
 * =========================
 */

singularity {
  enabled      = true
  autoMounts   = true
  pullTimeout  = '4h'

  /*
   * Use env var if set, otherwise default to work directory
   * Works across users and systems
   */
  cacheDir = "${System.getenv('NXF_SINGULARITY_CACHEDIR') ?: "$baseDir/.singularity"}"
}


/*
 * =========================
 *  PIPELINE REPORTING
 * =========================
 */

timeline {
  enabled   = true
  file      = "${params.log_dir}/timeline.html"
  overwrite = true
}

trace {
  enabled   = true
  file      = "${params.log_dir}/trace.txt"
  overwrite = true
}

report {
  enabled   = true
  file      = "${params.log_dir}/report.html"
  overwrite = true
}

dag {
  enabled   = true
  file      = "${params.log_dir}/flowchart.png"
  overwrite = true
}


/*
 * =========================
 *  EXECUTION PROFILES
 * =========================
 */

profiles {

  /*
   * Default: safe for most systems
   */
  standard {
    process.executor = 'local'
  }

  /*
   * Local workstation / laptop
   */
  local {
    process.executor = 'local'
    params.max_cpus   = 8
    params.max_memory = 32.GB
    params.max_time   = 6.h
  }

  /*
   * HPC / scheduler-based systems
   */
  hpc {
    process.executor = 'slurm'   // change if needed (pbs, lsf, sge)
    process.queue    = 'standard'
    process.clusterOptions = '--export=ALL'
  }
}
