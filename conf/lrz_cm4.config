/* ----------------------------------------------------
 * Nextflow config file for the LRZ cm4 cluster
 * ----------------------------------------------------
 */

manifest {
    name = 'LRZ CM4 Configuration'
    author = 'Amit Fenn, Niklas Schandry, Frederik DrÃ¶st'
    homePage = 'plantmicrobe.de'
    description = 'Configuration for LRZ CM4 cluster'
}

params {
    // Configuration metadata
    config_profile_name = 'LRZ CM4'
    config_profile_contact = 'Amit Fenn (@amitfenn); Niklas Schandry(@nschan)'
    config_profile_url = 'https://doku.lrz.de/job-processing-on-the-linux-cluster-10745970.html/'
    config_version = '1.0.0'
    // Default output directory (relative to launch directory)
    outdir = 'results'
}

apptainer {
    enabled = true
    autoMounts = true
}

process {
    beforeScript = 'module load apptainer/1.3.4'
}

profiles {
    serial {
        params {
            config_profile_description = 'LRZ CM4 - SERIAL configuration'
        }
        executor {
            queueStatInterval = '10 min'
            pollInterval = '30 sec'
            submitRateLimit = '25sec'
            queueSize = 200
        }
        process {
            executor = 'slurm'
            resourceLimits = {
                [cpus: 32, memory: 50.GB, time: 7.d]
            }
            queue = {
                task.time > 1.d
                    ? 'serial_long'
                    : 'serial_std'
            }
            clusterOptions = '--clusters=serial'
        }
    }

    shared {
        params {
            config_profile_description = 'LRZ CM4 tiny - shared nodes (9-112 cores) configuration'
        }
        process {
            executor = 'flux'
            resourceLimits = [
                cpus: System.getenv("SLURM_JOB_CPUS_PER_NODE").toInteger() * 2,
                memory: System.getenv("SLURM_MEM_PER_NODE").toInteger(),
                time: System.getenv("SLURM_JOB_PARTITION") == 'cm4_tiny' ? '24.h' : '10.d',
            ]
        }
    }

    exclusive {
        params {
            config_profile_description = 'LRZ CM4 std - multi-node configuration'
        }
        process {
            executor = 'flux'
            resourceLimits = [
                cpus: 224 * System.getenv('SLURM_NNODES').toInteger(),
                memory: 488.GB * System.getenv('SLURM_NNODES').toInteger(),
                time: 24.h
            ]
        }
    }
}

trace {
    enabled = true
    overwrite = true
}

report {
    enabled = true
    overwrite = true
}

timeline {
    enabled = true
    overwrite = true
}

dag {
    enabled = true
    overwrite = true
}
