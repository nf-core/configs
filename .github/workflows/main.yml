name: Configs tests

on: [pull_request, push]

# Cancel if a newer run is started
concurrency:
  group: ${{ github.workflow }}-${{ github.event.pull_request.number || github.ref }}
  cancel-in-progress: true

jobs:
  test_all_profiles:
    runs-on: ubuntu-latest
    name: Check if all profiles are tested
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Check whether profiles are all tested
        run: python ${GITHUB_WORKSPACE}/bin/cchecker.py ${GITHUB_WORKSPACE}/nfcore_custom.config ${GITHUB_WORKSPACE}/.github/workflows/main.yml

  check_nextflow_config:
    runs-on: ubuntu-latest
    name: Check if nextflow config runs in repository root
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - name: Install Nextflow
        run: |
          wget -qO- get.nextflow.io | bash
          sudo mv nextflow /usr/local/bin/
      - run: nextflow config -show-profiles ${GITHUB_WORKSPACE}

  profile_test:
    runs-on: ubuntu-latest
    name: Run ${{ matrix.profile }} profile | ${{ matrix.NXF_VER }}
    needs: test_all_profiles
    strategy:
      fail-fast: false
      matrix:
        profile:
          - "abims"
          - "adcra"
          - "alice"
          - "alliance_canada"
          - "apollo"
          - "arcc"
          - "aws_tower"
          - "awsbatch"
          - "azurebatch"
          - "bi"
          - "bigpurple"
          - "bih"
          - "binac"
          - "binac2"
          - "biohpc_gen"
          - "biowulf"
          - "bluebear"
          - "cambridge"
          - "cannon"
          - "cbe"
          - "ccga_dx"
          - "ccga_cau"
          - "ceci_dragon2"
          - "ceci_nic5"
          - "cedars"
          - "ceres"
          - "cfc"
          - "cfc_dev"
          - "cheaha"
          - "computerome"
          - "create"
          - "crg"
          - "crick"
          - "cropdiversityhpc"
          - "crukmi"
          - "csiro_petrichor"
          - "daisybio"
          - "denbi_qbic"
          - "dkfz"
          - "ebc"
          - "ebi_codon"
          - "ebi_codon_slurm"
          - "eddie"
          - "embl_hd"
          - "engaging"
          - "einstein"
          - "ethz_euler"
          - "eva"
          - "eva_grace"
          - "fgcz"
          - "fred_hutch"
          - "fsu_draco"
          - "fub_curta"
          - "genotoul"
          - "genouest"
          - "giga"
          - "gis"
          - "googlebatch"
          - "hasta"
          - "hki_genie"
          - "hypatia"
          - "humantechnopole"
          - "icr_alma"
          - "icr_davros"
          - "ifb_core"
          - "imb"
          - "ilifu"
          - "imperial"
          - "incliva"
          - "ipop_up"
          - "iris"
          - "janelia"
          - "jax"
          - "jex"
          - "unsw_katana"
          - "ku_sund_danhead"
          - "kaust"
          - "ki_luria"
          - "leicester"
          - "lrz_cm4"
          - "lugh"
          - "m3c"
          - "maestro"
          - "mana"
          - "marjorie"
          - "lovelace"
          - "dirac"
          - "marvin"
          - "mccleary"
          - "medair"
          - "mjolnir_globe"
          - "mpcdf"
          - "mpcdf_viper"
          - "mssm"
          - "munin"
          - "nci_gadi"
          - "nu_genomics"
          - "nygc"
          - "nyu_hpc"
          - "oist"
          - "pasteur"
          - "pawsey_nimbus"
          - "pawsey_setonix"
          - "pdc_kth"
          - "pe2"
          - "phoenix"
          - "psmn"
          - "qmul_apocrita"
          - "rki"
          - "rosalind"
          - "rosalind_uge"
          - "roslin"
          - "sage"
          - "sahmri"
          - "sanger"
          - "scw"
          - "seadragon"
          - "seattlechildrens"
          - "seawulf"
          - "seg_globe"
          - "self_hosted_runner"
          - "shu_bmrc"
          - "software_license"
          - "stjude"
          - "tes"
          - "tigem"
          - "tubingen_apg"
          - "tufts"
          - "tuos_stanage"
          - "ucl_cscluster"
          - "ucl_myriad"
          - "uct_hpc"
          - "ucd_sonic"
          - "uge"
          - "unibe_ibu"
          - "unity"
          - "unc_lccc"
          - "unc_longleaf"
          - "uod_hpc"
          - "uppmax"
          - "utd_ganymede"
          - "utd_juno"
          - "uw_hyak_pedslabs"
          - "uzh"
          - "uzl_omics"
          - "vai"
          - "vsc_calcua"
          - "vsc_kul_uhasselt"
          - "vsc_ugent"
          - "wehi"
          - "wustl_htcf"
          - "xanadu"
          - "york_viking"
        NXF_VER:
          - "25.04.8"
        include:
          # Test latest-everything with a representative subset of 10 profiles
          - profile: "uppmax"
            NXF_VER: "latest-everything"
          - profile: "awsbatch"
            NXF_VER: "latest-everything"
          - profile: "googlebatch"
            NXF_VER: "latest-everything"
          - profile: "crick"
            NXF_VER: "latest-everything"
          - profile: "denbi_qbic"
            NXF_VER: "latest-everything"
          - profile: "pasteur"
            NXF_VER: "latest-everything"
          - profile: "phoenix"
            NXF_VER: "latest-everything"
          - profile: "jax"
            NXF_VER: "latest-everything"
          - profile: "imperial"
            NXF_VER: "latest-everything"
          - profile: "eddie"
            NXF_VER: "latest-everything"

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6.0.2
      - uses: actions/setup-java@be666c2fcd27ec809703dec50e508c2fdc7f6654 # v5.2.0
        with:
          distribution: "temurin"
          java-version: "17"
      - name: Set up Nextflow
        uses: nf-core/setup-nextflow@561fcfc7146dcb12e3871909b635ab092a781f34 # v2.0.0
        with:
          version: ${{ matrix.NXF_VER }}
      - name: Check ${{ matrix.profile }}Â profile
        continue-on-error: ${{ matrix.NXF_VER == 'latest-everything' }}
        env:
          SCRATCH: "~"
          NXF_GLOBAL_CONFIG: awsbatch.config
        run: nextflow run ${GITHUB_WORKSPACE}/configtest.nf -profile ${{ matrix.profile }}
